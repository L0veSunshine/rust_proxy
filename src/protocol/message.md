# Protocol frame definition

## Control Message

### Client Hello

```text
+------------------+------+------+------+---------------------------+---------+---------------------------+
|    User Token    | Ver  | Type | Cmd  |      Target Address       | Pad Len |          Padding          |
|  (UUID 128-bit)  | 0x01 | 0x01 | 0x01 |     (ATYP + Addr + Port)  |  (2B)   |       (0-65536 Bytes)     |
+------------------+------+------+------+---------------------------+---------+---------------------------+
```

- MAGIC: 0xCD
- Ver: 0x01
- Type: 0x01 (保留字段，目前固定 0x01，未来可用作扩展)
- User Token: 16 字节 UUID。
- Cmd: 
  - 0x01 TCP Connect 
  - 0x02 UDP Associate
- Target Address: 见下。
- Pad Len: 随机数 N (16~128)。
- Padding: N 个随机字节。

### Server Response

```text
+----------+--------+-----------+
|  Length  | Status |  Padding  |
|   (1B)   |  (1B)  |    N-1    |
+----------+--------+-----------+
```
- 0x00: 成功。连接建立，TCP后续流量直接转发。UDP使用[UDP帧格式](#udp)
- 0x01: 鉴权失败。
- 0x02: 超限/拒绝。

## Data Transfer

### UDP
```text
+-----------+---------------------------+-------------------------------+
| Body Len  |      Target Address       |            Payload            |
| (2 Bytes) |        (Variable)         |           (N Bytes)           |
+-----------+---------------------------+-------------------------------+
      ^                   ^
      |                   |
      |                   +---> Target Address
      +---> Big Endian, 表示后续数据的总长度 (Addr + Payload)
```

## Target Address

### Ipv4

```text
+------+-----------------------+-----------------------+
| ATYP |       IPv4 Addr       |         Port          |
| 0x01 |       (4 Bytes)       |       (2 Bytes)       |
+------+-----------------------+-----------------------+
    |              |                        |
    |              |                        +---> Big Endian (e.g. 443 = 0x01 0xBB)
    |              +---> e.g. 192.168.1.1 = C0 A8 01 01
    +---> Type 1
```

### Domain

```text
+------+------+-------------------------------+-----------------------+
| ATYP | Len  |            Domain             |         Port          |
| 0x03 | (1B) |          (Len Bytes)          |       (2 Bytes)       |
+------+------+-------------------------------+-----------------------+
   |      |                  |                            |
   |      |                  |                            +---> 端口
   |      |                  +---> "google.com" (ASCII/UTF8)
   |      +---> 域名长度 (e.g. 10)
   +---> Type 3
```

### Ipv6

```text
+------+---------------------------------------------------------------+-----------------------+
| ATYP |                           IPv6 Addr                           |         Port          |
| 0x04 |                          (16 Bytes)                           |       (2 Bytes)       |
+------+---------------------------------------------------------------+-----------------------+
```